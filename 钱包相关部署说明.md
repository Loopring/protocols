### 1.环境准备（一些基础准备的说明都整理到这里）
#### 1. 代码库，每个的分支 
1. protocols   https://github.com/Loopring/protocols  
   1. 用于部署各个版本的 SmartWallet，分支可能发生变化，执行前请与开发人员确认
      1. V2 版本：`xl/remove_salt` 分支, `package/hebao_v2` 目录
      2. V3 版本：`xl/estimateGas` 分支, `package/hebao_v3` 目录
   2. hardhat配置说明
      1. network相关
        ```
        ethereum: {
        //获取 URL: https://docs.infura.io/api
        url: `https://mainnet.infura.io/v3/${process.env.INFURA_API_KEY}`,
        accounts: [privateKey]
        // 交易的 gasPrice，不设置将自动获取
        gasPrice: 2000000000
        }
        ```
      2. etherscan配置说明  
       ```
        etherscan: {
        // 获取 API Key: https://docs.etherscan.io/getting-started/viewing-api-usage-statistics
        // 用于验证部署的合约
        apiKey: "1F73WEV5ZM2HKPIVCG65U5QQ427NPUG9FI",
        }
        ```
   3. env配置说明
      * `PRIVATE_KEY`: deployer 私钥，部署合约使用  
      * `TEST_ACCOUNT_PRIVATE_KEY`: 测试账户私钥，创建 Demo 钱包使用，一般与 deployer 私钥一致即可  
      * `PAYMASTER_OWNER_PRIVATE_KEY`: paymasterOwner 私钥，一般与 deployer 私钥一致即可  
      * `BLANK_OWNER`: `SmartWalletImpl` 的 Owner，一般填 deployer 的地址即可  
      * `ETHERSCAN_API_KEY`: etherscan 的 API Key，验证合约用  
      * `INFURA_API_KEY`: Infura 的 API Key，调节点 RPC用  
   4. 说明  
      1. 命令行参数 `--network` 指hardhat config里存在的networks
      2. `.env`里的`ENV`指的是不同环境的部署合约（dev一套wallet合约，prod一套wallet合约）
      3. 合约部署要执行两次，第一次是部署合约，第二次是verify
   5. 安装依赖: `yarn install`
2. eth-tools  https://github.com/Loopring/eth-tools
   1. 用于部署 Exchange 相关合约
   2. hardhat配置参考 protocols 里的说明
   3. env配置说明  
      * `PRIV_KEY`: deployer 私钥，部署合约使用  
      * `ENV`: 合约所属环境。一个合约可能在一个网络上部署多个副本，通过环境进行区分
   4. 说明 
      1. 命令行参数 `--network` 指hardhat config里存在的networks
      2. `.env`里的`ENV`指的是不同环境的部署合约（dev一套wallet合约，prod一套wallet合约）
      3. 合约部署要执行两次，第一次是部署合约，第二次是verify
   5. 安装依赖: `yarn install`

### 2. 基础操作（一些公用的操作说明都整理到这里）
#### 1. 新部署的合约 转移权限：钱包合约部署可以由任意人，用任意的opeartor部署，但部署完 需要转移owner权限给路印管理地址
1. 使用 eth-tools，将陈胜的硬件钱包: `0x88f8Dbd3dC44c6E2e368258D3eee8EB9A07aF191`填入 `deployments/config.json` 文件的 `owner` 字段，以下合约的 Owner 将被转为该地址(合约地址从`deployments/<network>`目录中的文件读取)：
    - `DelayedImplementationManager`
    - `WalletFactory`
    - `LoopringCreate2Deployer`
2. 执行脚本  
   `yarn hardhat run --network <network> ./scripts/transfer_ownership.ts`  
   填写的 network 必须在 `hardhat.config.ts` 文件中有相应的配置。运行成功后，可在 `deployments`目录中找到部署的合约信息
#### 2. create2合约权限（如果用create2部署同地址，需要先拿到权限） 
1. 用create2合约部署的目的是部署出同地址，比如walletFactory
2. 各网络上create2地址
   * sepolia: 0x391fD52903D1531fd45F41c4A354533c91289F5F
   * taiko6: 0x391fD52903D1531fd45F41c4A354533c91289F5F
   * taiko7: 0x391fD52903D1531fd45F41c4A354533c91289F5F
3. 读取合约的 Owner 方法检查当前权限在哪个地址
4. 如果你要用create2合约部署同地址，需要先把create2权限转移给你的私钥对应的地址。当前 Owner 转移后，你需要手动调用 claimOwnership 方法
5. 用完以后调用 transferOwnership 方法将权限还给原 Owner
#### 3. 多签发起registerUniversalAgent流程（用在walletFactory部署完后，和exchange部署反事实agent）：
   1. 多签钱包发起交易
   2. 贴入目的地址0x39B9bf169a7e225ba037C443A40460c77438ea14
   3. 选择registerUniversalAgent
   4. 填入agent地址比如0x1945e350291C9c7DFe9B7cEe428cA815DF31Fec2
   5. 点击 Add transaction

### 3. 具体操作说明
   1. wallet相关：
      钱包合约目前有v2和v3两个版本，需要用到的合约包括基础库(Lib)、实现(smartWallet)、walletFactory、official guardian。4337的v3实现还包括entrypoint、paymaster等
      1. v2 smartWallet：需要Lib，smartWallet，walletFactory
         1. 操作文档：https://github.com/Loopring/protocols/blob/xl/estimateGas/packages/hebao_v2/deploy_wallet.md
         2. owner权限确认
            1. 读取合约的 Owner 方法检查当前权限在哪个地址
            2. 转移owner权限：参考 `2. 基础操作 ->  1. 新部署的合约 转移权限`
      2. v3 smartWallet：需要Lib，smartWallet，walletFactory，entrypoint（如果用官方的就不用部署，自己测试的话 要部署，怎么部署？）paymaster
         1. 操作文档 https://github.com/Loopring/protocols/blob/xl/remove_salt/%E5%90%88%E7%BA%A6%E9%83%A8%E7%BD%B2%E8%AF%B4%E6%98%8E.md
         2. owner权限        
            1. 读取合约的 Owner 方法检查当前权限在哪个地址
            2. 转移owner权限：参考 `2. 基础操作 ->  1. 新部署的合约 转移权限`   
         3. 各网络上entrypoint地址
            * sepolia: 0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789
            * taiko6: 0x779eEcA2315a44D20806217c005731aE7DDB5ca0
            * taiko7: 0x5C07472a097D0e7212612846305a73342Dc01b9A
         5. paymaster
            1. 部署 smartWallet 时同时部署
            2. 怎么查看权限在哪
            3. 转移owner权限：参考 `2. 基础操作 ->  1. 新部署的合约 转移权限`
            4. opeartor（signer，指的是paymaster认可这个operator签名的valutOfEth:token兑换率）怎么查看，设置
           
      3. walletFactory
         1. 部署同地址。解释为什么要部署同地址，怎么部署同地址 https://github.com/Loopring/eth-tools/blob/main/deploy_exchange.md
         2. 部署不同地址
            如果要部署不同地址的 walletFactory，修改 `deployments/config.json` 文件 `implV2` 字段，目前只支持 V2 不同地址部署
         4. 怎么改smartWallet实现？两步分别都要怎么做
            1. `update_impl.ts`把`/deployments/$network/deployment_shared`里的`DelayedImplementationManagerV2`（walletFactory 延迟升级）实现改成`/deployments/config.json`里的`implV2`对应的合约版本（smartWallet部署出来的具体实现）。这一步调用`DelayedImplementationManager`合约里的`delayedUpgradeTo`
            2. 如果设置完，`nextEffectiveTime` 是delay1天生效，需要1天后再执行`executeUpgrade`。再执行一次`update_impl.ts` 或在etherscan上执行
         6. owner权限转移
            1. 读取合约的 Owner 方法检查当前权限在哪个地址
            2. 转移owner权限：参考 `2. 基础操作 ->  1. 新部署的合约 转移权限`
         7. 再加上operator权限设置（指的是哪些地址能调用walletFactory部署）
            1. 列出每条链的operator设置成什么（如果新部署一个walletFactory，就按照这个配置去设置operators）
            2. 谁有权限去改？怎么查看
            3. 怎么查看当前设置的operators
            4. 怎么改operator（添加，删除）
         8. dex agent部署（用部署不同地址的walletFactory脚本部署）
            1. 需要的合约：
               1. `config.json`里的`implV2`配成smartWallet实现（这里的v2只是部署方式，不是指的wallet v2, v3）
               2. `config.json`里的`new-exchange`配成要绑定agent的dex地址
               3. `$network/deployment_shared`里的`WalletFactoryV2` 是要绑定的walletFactory合约地址
               4. `$network/deployments`里的`AgentRegistry`（如果已有这个合约要配置进，没配会重新部署）
               5. `$network/deployments`里的`LoopringWalletAgentV2`（如果已有这个合约要配置进，没配会重新部署）
            3. 命令：`yarn hardhat run scripts/deploy_walletfactory.ts --network ethereum`
            4. 如果用脚本一键部署（新搞一套测试环境，合约都重新部署），脚本里的`registerUniversalAgent`会执行agent注册
            5. 如果主网，部署合约的operator没有`AgentRegistry`owner权限（在多签地址），需要多签部署，需要由多签发起`registerUniversalAgent`:参考`2. 基础操作 -> 3. 多签发起registerUniversalAgent流程`）。
         9. 新部署的walletFactory，要和所有dex绑定agent，怎么做？改哪个配置（指定walletFactory和要绑定的dex exchange，创建出agent）执行哪个脚本
      4. official guardian
         1. 与 Exchange 相关合约一同部署，文档：https://github.com/Loopring/eth-tools/blob/main/deploy_exchange.md
         2. owner权限
            1. 读取合约的 Owner 方法检查当前权限在哪个地址
            2. 转移owner权限：参考 `2. 基础操作 ->  1. 新部署的合约 转移权限`  
         3. operator设置（指的是哪个地址能提交official guardian的签名，每条链的operator设置成什么，谁有权限去改？）
      5. sepolia已经部署出的所有地址整理（LoopringCreate2Deployer、EntryPoint、xxxLib...）

### 4. 异常解决
1. 找不到artifacts
```
[Error: ENOENT: no such file or directory, open '/protocols/packages/hebao_v3/artifacts/build-info/70f19c75c27aedce6ec0abf6696e0321.json'] {
  errno: -2,
  code: 'ENOENT',
  syscall: 'open',
  path: '/protocols/packages/hebao_v3/artifacts/build-info/70f19c75c27aedce6ec0abf6696e0321.json'
}
```

尝试:`yarn hardhat clean`
