#  合约部署说明

## 部署命令

1. 克隆部署工具  
   `git clone https://github.com/Loopring/protocols.git`
2. 切换分支（分支可能发生变化，执行前请与开发人员确认）   
   `git checkout xl/remove_salt ; cd packages/hebao_v3`
3. 安装依赖  
   `yarn install`
4. 环境变量配置（在hebao_v3目录下，copy`.env.example`生成新文件`.env`，改里面的私钥）  
   `PRIVATE_KEY`: deployer 私钥，部署合约使用  
   `TEST_ACCOUNT_PRIVATE_KEY`: 测试账户私钥，创建 Demo 钱包使用，一般与 deployer 私钥一致即可  
   `PAYMASTER_OWNER_PRIVATE_KEY`: paymasterOwner 私钥，一般与 deployer 私钥一致即可  
   `BLANK_OWNER`: `SmartWalletImpl` 的 Owner，一般填 deployer 的地址即可  
   `ETHERSCAN_API_KEY`: etherscan 的 API Key，验证合约用  
   `INFURA_API_KEY`: Infura 的 API Key，调节点 RPC用  
5. 配置 `deployments/deployments.json`  
    ```json
    {
        // network 名
        "goerli": {
            // 如果要部署新的 LoopringCreate2Deployer 和 Entrypoint，不要填写地址
            // 如果已经部署过，填写地址
            "LoopringCreate2Deployer": "",
            "EntryPoint": "",
        }
    }
    ```

6. 执行部署脚本  
   `yarn hardhat run script/deploy_impl.ts --network <network>`  
   填写的 network 必须在 `hardhat.config.ts` 文件中有相应的配置。运行成功后，可在 `deployments`目录中找到部署的合约信息
7. 提交`deployments`目录中的新部署的合约的信息

## 部署步骤

1. 如果 `deployments/deployments.json` 中对应`network`下没有配置 `LoopringCreate2Deployer` 的地址，部署`LoopringCreate2Deployer`
2. 如果 `deployments/deployments.json` 中对应`network`下没有配置 `EntryPoint` 的地址，部署 `EntryPoint`
3. 部署 `LoopringPaymaster`，Owner 为 `PAYMASTER_OWNER_PRIVATE_KEY` 对应的地址
4. 部署 `SmartWalletImpl`，Owner 为 `BLANK_OWNER` ，详细说明见下文
5. 以 `SmartWalletImpl` 的地址为参数，部署 `DelayedImplementationManager`，并将 Owner 转给 deployer
6. 以 `DelayedImplementationManager` 的地址为参数，部署 `ForwardProxy`
7. 以 `ForwardProxy` 的地址为参数，部署 `WalletFactory`，并将 Owner 转给 deployer
8. 如果 deployer 不是 `WalletFactory` 的 Operator，将 deployer 注册为 `WalletFactory` 的 Operator

## 部署 WalletImpl 说明

依赖合约：
* `LoopringCreate2Deployer`  
* `EntryPoint`  

前置合约：
* `ERC1271Lib`  
* `ERC20Lib`  
* `GuardianLib`  
* `InheritanceLib`  
* `QuotaLib`  
* `UpgradeLib`  
* `WhitelistLib`  
* `LockLib`  
* `RecoverLib`  
* `ApprovalLib`  
* `ConnectorRegistry`  

执行步骤：

1. 部署前置合约
2. 部署 `SmartWalletV3`，所需参数:
   1. `priceOracleAddr`：可以为 0x0000000000000000000000000000000000000000
   2. `blankOwner`
   3. `entryPointAddr`
   4. `connectorRegistryAddr`
